# 申请微信支付

功能 - 微信支付 - 接入微信支付 - 申请接入，若该主体还没有申请过微信商户号，则点击申请接入，会跳转进入[接入微信支付 - 微信商户平台 (qq.com)](https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal#none)

管理员微信扫码 - 填写姓名、电话、短信验证码、邮箱 - 确认申请

上传营业执照 - 上传法人身份证 - 上传管理员身份证、授权函（若为法人则不需要） - 填写商户简称、客服电话、所属行业、经营场景（小程序需appid、设计图）、对公账户信息

> [腾讯客服-微信支付商户专区 (qq.com)](https://kf.qq.com/product/wechatpaymentmerchant.html#hid=hot_faq)
>
> [业务办理授权函 (qq.com)](https://kf.qq.com/faq/220509Y3Yvym220509fQvYR7.html)

> [!TIP]
>
> 所属行业会影响手续费费率，参看[入驻结算规则、行业属性及特殊资质 (qq.com)](https://kf.qq.com/faq/220228IJb2UV220228uEjU3Q.html)，部分行业需要上传资质证明。

# 微信支付开发必要参数

### 商户id

`merchantId: 1636100000`

开通微信支付即获得

> [JSAPI支付-接入前准备 | 微信支付商户平台文档中心 (qq.com)](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_1.shtml)

### 商户私钥（商户API证书）（商户RSA私钥）

用于对请求参数签名

私钥文件：账户中心 - API 安全 - 申请API证书，根据提示，下载证书下载工具即可下载

`privateKeyPath: D:\wechatpay\1636100000_20221117_cert\apiclient_key.pem`

商户证书序列号（40位）：用于告知微信所使用的商户证书，账户中心 - API 安全 - 申请API证书 - 管理证书，即可查看

`merchantSerialNumber: 68BA6xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

> [私钥和证书-接口规则 | 微信支付商户平台文档中心 (qq.com)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml)
>
> [什么是商户API证书？如何获取商户API证书？ (qq.com)](https://kf.qq.com/faq/161222NneAJf161222U7fARv.html)

### 平台证书（微信平台RSA公钥）

用于对下载证书、回调接口进行验签。平台证书会不定期升级，所以这里的配置应为文件夹，根据请求参数中的证书序列号选用对应的证书。

`wechatPayCertificateDir: D:\wechatpay\1636100000_20221117_cert\platform`

> [私钥和证书-接口规则 | 微信支付商户平台文档中心 (qq.com)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml)

下载证书需要公钥验签，所以首次下载可以使用微信提供的证书下载工具

> [获取平台证书列表-文档中心-微信支付商户平台 (qq.com)](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/wechatpay5_1.shtml)
>
> [wechatpay-apiv3/CertificateDownloader: Java 微信支付 APIv3 平台证书的命令行下载工具 (github.com)](https://github.com/wechatpay-apiv3/CertificateDownloader)

### API v3密钥（AES）

用于对回调通知和平台证书下载接口消息解密

`apiV3Key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

> [API v3密钥-接口规则 | 微信支付商户平台文档中心 (qq.com)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_2.shtml)

### 回调通知

调用支付、退款接口的参数，当支付、退款完成时，微信会回调该接口。故不同类型的支付、退款可以设置不同的回调地址。

`payNotifyUrl: https://xxxxx/api/pay`

`refundsNotifyUrl: https://xxxxx/api/refunds`



> ### 声明所使用的证书
>
> 某些情况下，将需要更新密钥对和证书。为了保证更换过程中不影响API的使用，请求和应答的HTTP头部中包括*证书序列号* ，以声明签名或者加密所用的密钥对和证书。
>
> - 商户签名使用 *商户私钥* ，证书序列号包含在请求HTTP头部的 ` Authorization`的`serial_no`
> - 微信支付签名使用*微信支付平台私钥*，证书序列号包含在应答HTTP头部的`Wechatpay-Serial`
> - 商户上送敏感信息时使用*微信支付平台公钥*加密，证书序列号包含在请求HTTP头部的` Wechatpay-Serial `
>
> 请参考[如何查看证书序列号。](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay7_0.shtml#part-5)
>
> [私钥和证书-接口规则 | 微信支付商户平台文档中心 (qq.com)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml)

# 获取必要参数

### 商户私钥

账户中心 - API安全 - 申请API证书 - 点击申请证书，弹出“生成API证书”页面

下载安装证书工具，复制页面中的商户号和商户名称到工具中，点击下一步，复制证书请求串到页面中，点击下一步。此时会提示设置操作密码。设置完成后在页面中点击下一步，获得证书串，粘贴到工具中，点击下一步即可下载`商户API证书私钥`文件。

账户中心 - API 安全 - 申请API证书 - 管理证书，查看`商户证书序列号`。

### APIV3密钥

账户中心 - API安全 - 设置`APIV3密钥`，使用32位字符串。

### 平台证书

完成以上两步后，下载证书下载工具[wechatpay-apiv3/CertificateDownloader: Java 微信支付 APIv3 平台证书的命令行下载工具 (github.com)](https://github.com/wechatpay-apiv3/CertificateDownloader)

```bash
# 示例
java -jar CertificateDownloader.jar -k ${apiV3key} -m ${mchId} -f ${mchPrivateKeyFilePath} -s ${mchSerialNo} -o ${outputFilePath} -c ${wechatpayCertificateFilePath}

# cd到私钥目录，创建platform用于放置平台证书
cd /d D:\wechatpay\1636100000_20221117_cert
java -jar CertificateDownloader.jar -k xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -m 1636100000 -f apiclient_key.pem -s 68BA6xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -o platform
```