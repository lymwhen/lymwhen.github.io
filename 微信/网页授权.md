# ç½‘é¡µæˆæƒ

> ### å…³äºç½‘é¡µæˆæƒå›è°ƒåŸŸåçš„è¯´æ˜
>
> 1. åœ¨å¾®ä¿¡å…¬ä¼—å·è¯·æ±‚ç”¨æˆ·ç½‘é¡µæˆæƒä¹‹å‰ï¼Œå¼€å‘è€…éœ€è¦å…ˆåˆ°å…¬ä¼—å¹³å°å®˜ç½‘ä¸­çš„â€œå¼€å‘ - æ¥å£æƒé™ - ç½‘é¡µæœåŠ¡ - ç½‘é¡µå¸å· - ç½‘é¡µæˆæƒè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯â€çš„é…ç½®é€‰é¡¹ä¸­ï¼Œä¿®æ”¹æˆæƒå›è°ƒåŸŸåã€‚è¯·æ³¨æ„ï¼Œè¿™é‡Œå¡«å†™çš„æ˜¯åŸŸåï¼ˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰ï¼Œè€Œä¸æ˜¯URLï¼Œå› æ­¤è¯·å‹¿åŠ  http:// ç­‰åè®®å¤´ï¼›
> 2. æˆæƒå›è°ƒåŸŸåé…ç½®è§„èŒƒä¸ºå…¨åŸŸåï¼Œæ¯”å¦‚éœ€è¦ç½‘é¡µæˆæƒçš„åŸŸåä¸ºï¼šwww.qq.comï¼Œé…ç½®ä»¥åæ­¤åŸŸåä¸‹é¢çš„é¡µé¢http://www.qq.com/music.html ã€ http://www.qq.com/login.html éƒ½å¯ä»¥è¿›è¡ŒOAuth2.0é‰´æƒã€‚ä½†http://pay.qq.com ã€ http://music.qq.com ã€ http://qq.com æ— æ³•è¿›è¡ŒOAuth2.0é‰´æƒ
> 3. å¦‚æœå…¬ä¼—å·ç™»å½•æˆæƒç»™äº†ç¬¬ä¸‰æ–¹å¼€å‘è€…æ¥è¿›è¡Œç®¡ç†ï¼Œåˆ™ä¸å¿…åšä»»ä½•è®¾ç½®ï¼Œç”±ç¬¬ä¸‰æ–¹ä»£æ›¿å…¬ä¼—å·å®ç°ç½‘é¡µæˆæƒå³å¯
>
> ### å…³äºç½‘é¡µæˆæƒçš„ä¸¤ç§ scope çš„åŒºåˆ«è¯´æ˜
>
> 1. ä»¥snsapi_baseä¸º scope å‘èµ·çš„ç½‘é¡µæˆæƒï¼Œæ˜¯ç”¨æ¥è·å–è¿›å…¥é¡µé¢çš„ç”¨æˆ·çš„ openid çš„ï¼Œå¹¶ä¸”æ˜¯é™é»˜æˆæƒå¹¶è‡ªåŠ¨è·³è½¬åˆ°å›è°ƒé¡µçš„ã€‚ç”¨æˆ·æ„ŸçŸ¥çš„å°±æ˜¯ç›´æ¥è¿›å…¥äº†å›è°ƒé¡µï¼ˆå¾€å¾€æ˜¯ä¸šåŠ¡é¡µé¢ï¼‰
> 2. ä»¥snsapi_userinfoä¸º scope å‘èµ·çš„ç½‘é¡µæˆæƒï¼Œæ˜¯ç”¨æ¥è·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯çš„ã€‚ä½†è¿™ç§æˆæƒéœ€è¦ç”¨æˆ·æ‰‹åŠ¨åŒæ„ï¼Œå¹¶ä¸”ç”±äºç”¨æˆ·åŒæ„è¿‡ï¼Œæ‰€ä»¥æ— é¡»å…³æ³¨ï¼Œå°±å¯åœ¨æˆæƒåè·å–è¯¥ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚
> 3. ç”¨æˆ·ç®¡ç†ç±»æ¥å£ä¸­çš„â€œè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æ¥å£â€ï¼Œæ˜¯åœ¨ç”¨æˆ·å’Œå…¬ä¼—å·äº§ç”Ÿæ¶ˆæ¯äº¤äº’æˆ–å…³æ³¨åäº‹ä»¶æ¨é€åï¼Œæ‰èƒ½æ ¹æ®ç”¨æˆ· OpenID æ¥è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€‚è¿™ä¸ªæ¥å£ï¼ŒåŒ…æ‹¬å…¶ä»–å¾®ä¿¡æ¥å£ï¼Œéƒ½æ˜¯éœ€è¦è¯¥ç”¨æˆ·ï¼ˆå³openidï¼‰å…³æ³¨äº†å…¬ä¼—å·åï¼Œæ‰èƒ½è°ƒç”¨æˆåŠŸçš„ã€‚
>
> ## å¼€å‘æŒ‡å—
>
> ç½‘é¡µæˆæƒæµç¨‹åˆ†ä¸ºå››æ­¥ï¼š
>
> 1. å¼•å¯¼ç”¨æˆ·è¿›å…¥æˆæƒé¡µé¢åŒæ„æˆæƒï¼Œè·å–code
> 2. é€šè¿‡ code æ¢å–ç½‘é¡µæˆæƒaccess_tokenï¼ˆä¸åŸºç¡€æ”¯æŒä¸­çš„access_tokenä¸åŒï¼‰
> 3. å¦‚æœéœ€è¦ï¼Œå¼€å‘è€…å¯ä»¥åˆ·æ–°ç½‘é¡µæˆæƒaccess_tokenï¼Œé¿å…è¿‡æœŸ
> 4. é€šè¿‡ç½‘é¡µæˆæƒaccess_tokenå’Œ openid è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆæ”¯æŒ UnionID æœºåˆ¶ï¼‰
>
> [ç½‘é¡µæˆæƒ | å¾®ä¿¡å¼€æ”¾æ–‡æ¡£ (qq.com)](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)

### è·å– code

ç®€å•æ¥è¯´ï¼Œå¾®ä¿¡ç½‘é¡µç™»å½•å°±æ˜¯è®¿é—®å¾®ä¿¡çš„ä¸€ä¸ªåœ°å€ï¼Œå¸¦ä¸Š`appid`/`redirect_uri`/`state`å‚æ•°ï¼Œå½¢å¦‚ï¼š

```
https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxf0e81c3bee622d60&redirect_uri=http%3A%2F%2Fwww.expamle.com%2Fapp%2Findex.html%23%2FweChatLogin&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect
```

`appid`ï¼šå¾®ä¿¡å…¬ä¼—å·çš„`appid`

`redirect_uri`ï¼šé‡å®šå‘åœ°å€ï¼Œå³è‡ªå·±ç½‘é¡µçš„åœ°å€ï¼Œæ³¨æ„éœ€è¦ encodeURL å¤„ç†

`state`ï¼šå¯ä»¥ä»»æ„å¡«å†™çš„å‚æ•°ï¼Œæ¯”å¦‚å¯ä»¥ç”¨äºåŒºåˆ†è‡ªå·±çš„åº”ç”¨ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡é‡å®šå‘åœ°å€çš„å‚æ•°æ¥åšï¼‰

> [!NOTE]
>
> é‡å®šå‘åœ°å€çš„åŸŸåéœ€è¦å…ˆåˆ°å¾®ä¿¡å…¬ä¼—å·`å¼€å‘ - æ¥å£æƒé™ - ç½‘é¡µæœåŠ¡ - ç½‘é¡µå¸å· - ç½‘é¡µæˆæƒè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯`ä¸­é…ç½®ã€‚

åœ¨å¾®ä¿¡æ ¡éªŒäº†æ˜¯å¦å·²ç»å…³æ³¨å…¬ä¼—å·ã€å›è°ƒåŸŸåæ˜¯å¦åˆæ³•ã€ç”¨æˆ·ç‚¹å‡»åŒæ„ä¹‹åï¼Œä¼šé‡å®šå‘åˆ°`redirect_uri`ï¼Œå¹¶åŠ ä¸Š`code`å’Œ`state`å‚æ•°ï¼š

```
http://www.expamle.com/app/index.html?code=xxxxxxxxxxxxxxx&state=STATE#/weChatLogin
```

> **å‚æ•°è¯´æ˜**
>
> | å‚æ•°             | æ˜¯å¦å¿…é¡» | è¯´æ˜                                                         |
> | :--------------- | :------- | :----------------------------------------------------------- |
> | appid            | æ˜¯       | å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†                                             |
> | redirect_uri     | æ˜¯       | æˆæƒåé‡å®šå‘çš„å›è°ƒé“¾æ¥åœ°å€ï¼Œ è¯·ä½¿ç”¨ urlEncode å¯¹é“¾æ¥è¿›è¡Œå¤„ç† |
> | response_type    | æ˜¯       | è¿”å›ç±»å‹ï¼Œè¯·å¡«å†™code                                         |
> | scope            | æ˜¯       | åº”ç”¨æˆæƒä½œç”¨åŸŸï¼Œsnsapi_base ï¼ˆä¸å¼¹å‡ºæˆæƒé¡µé¢ï¼Œç›´æ¥è·³è½¬ï¼Œåªèƒ½è·å–ç”¨æˆ·openidï¼‰ï¼Œsnsapi_userinfo ï¼ˆå¼¹å‡ºæˆæƒé¡µé¢ï¼Œå¯é€šè¿‡ openid æ‹¿åˆ°æ˜µç§°ã€æ€§åˆ«ã€æ‰€åœ¨åœ°ã€‚å¹¶ä¸”ï¼Œ å³ä½¿åœ¨æœªå…³æ³¨çš„æƒ…å†µä¸‹ï¼Œåªè¦ç”¨æˆ·æˆæƒï¼Œä¹Ÿèƒ½è·å–å…¶ä¿¡æ¯ ï¼‰ |
> | state            | å¦       | é‡å®šå‘åä¼šå¸¦ä¸Š state å‚æ•°ï¼Œå¼€å‘è€…å¯ä»¥å¡«å†™a-zA-Z0-9çš„å‚æ•°å€¼ï¼Œæœ€å¤š128å­—èŠ‚ |
> | #wechat_redirect | æ˜¯       | æ— è®ºç›´æ¥æ‰“å¼€è¿˜æ˜¯åšé¡µé¢302é‡å®šå‘æ—¶å€™ï¼Œå¿…é¡»å¸¦æ­¤å‚æ•°            |
> | forcePopup       | å¦       | å¼ºåˆ¶æ­¤æ¬¡æˆæƒéœ€è¦ç”¨æˆ·å¼¹çª—ç¡®è®¤ï¼›é»˜è®¤ä¸ºfalseï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥ç”¨æˆ·å‘½ä¸­äº†ç‰¹æ®Šåœºæ™¯ä¸‹çš„é™é»˜æˆæƒé€»è¾‘ï¼Œåˆ™æ­¤å‚æ•°ä¸ç”Ÿæ•ˆ |
>
> **ç”¨æˆ·åŒæ„æˆæƒå**
>
> å¦‚æœç”¨æˆ·åŒæ„æˆæƒï¼Œé¡µé¢å°†è·³è½¬è‡³ redirect_uri/?code=CODE&state=STATEã€‚
>
> codeè¯´æ˜ï¼š
>
> codeä½œä¸ºæ¢å–access_tokençš„ç¥¨æ®ï¼Œæ¯æ¬¡ç”¨æˆ·æˆæƒå¸¦ä¸Šçš„ code å°†ä¸ä¸€æ ·ï¼Œcodeåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œ5åˆ†é’Ÿæœªè¢«ä½¿ç”¨è‡ªåŠ¨è¿‡æœŸã€‚
>
> **é”™è¯¯è¿”å›ç è¯´æ˜**
>
> | è¿”å›ç  | è¯´æ˜                                         |
> | :----- | :------------------------------------------- |
> | 10003  | redirect_uriåŸŸåä¸åå°é…ç½®ä¸ä¸€è‡´             |
> | 10004  | æ­¤å…¬ä¼—å·è¢«å°ç¦                               |
> | 10005  | æ­¤å…¬ä¼—å·å¹¶æ²¡æœ‰è¿™äº› scope çš„æƒé™              |
> | 10006  | å¿…é¡»å…³æ³¨æ­¤æµ‹è¯•å·                             |
> | 10009  | æ“ä½œå¤ªé¢‘ç¹äº†ï¼Œè¯·ç¨åé‡è¯•                     |
> | 10010  | scopeä¸èƒ½ä¸ºç©º                                |
> | 10011  | redirect_uriä¸èƒ½ä¸ºç©º                         |
> | 10012  | appidä¸èƒ½ä¸ºç©º                                |
> | 10013  | stateä¸èƒ½ä¸ºç©º                                |
> | 10015  | å…¬ä¼—å·æœªæˆæƒç¬¬ä¸‰æ–¹å¹³å°ï¼Œè¯·æ£€æŸ¥æˆæƒçŠ¶æ€       |
> | 10016  | ä¸æ”¯æŒå¾®ä¿¡å¼€æ”¾å¹³å°çš„Appidï¼Œè¯·ä½¿ç”¨å…¬ä¼—å·Appid |
>
> [ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·åŒæ„æˆæƒï¼Œè·å–code - ç½‘é¡µæˆæƒ | å¾®ä¿¡å¼€æ”¾æ–‡æ¡£ (qq.com)](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html#0)

### è·å– access_token/openid

> **è¯·æ±‚æ–¹æ³•**
>
> è·å– code åï¼Œè¯·æ±‚ä»¥ä¸‹é“¾æ¥è·å–access_tokenï¼š
>
> ```
> https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&secret=SECRET&code=CODE&grant_type=authorization_code
> ```
>
> 
>
> | å‚æ•°       | æ˜¯å¦å¿…é¡» | è¯´æ˜                       |
> | :--------- | :------- | :------------------------- |
> | appid      | æ˜¯       | å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†           |
> | secret     | æ˜¯       | å…¬ä¼—å·çš„appsecret          |
> | code       | æ˜¯       | å¡«å†™ç¬¬ä¸€æ­¥è·å–çš„ code å‚æ•° |
> | grant_type | æ˜¯       | å¡«å†™ä¸ºauthorization_code   |
>
> **è¿”å›è¯´æ˜**
>
> æ­£ç¡®æ—¶è¿”å›çš„ JSON æ•°æ®åŒ…å¦‚ä¸‹ï¼š
>
> ```json
> {
>   "access_token":"ACCESS_TOKEN",
>   "expires_in":7200,
>   "refresh_token":"REFRESH_TOKEN",
>   "openid":"OPENID",
>   "scope":"SCOPE" 
> }
> ```
>
> | å‚æ•°            | æè¿°                                                         |
> | :-------------- | :----------------------------------------------------------- |
> | access_token    | ç½‘é¡µæˆæƒæ¥å£è°ƒç”¨å‡­è¯,æ³¨æ„ï¼šæ­¤access_tokenä¸åŸºç¡€æ”¯æŒçš„access_tokenä¸åŒ |
> | expires_in      | access_tokenæ¥å£è°ƒç”¨å‡­è¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼ˆç§’ï¼‰                 |
> | refresh_token   | ç”¨æˆ·åˆ·æ–°access_token                                         |
> | openid          | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼Œè¯·æ³¨æ„ï¼Œåœ¨æœªå…³æ³¨å…¬ä¼—å·æ—¶ï¼Œç”¨æˆ·è®¿é—®å…¬ä¼—å·çš„ç½‘é¡µï¼Œä¹Ÿä¼šäº§ç”Ÿä¸€ä¸ªç”¨æˆ·å’Œå…¬ä¼—å·å”¯ä¸€çš„OpenID |
> | scope           | ç”¨æˆ·æˆæƒçš„ä½œç”¨åŸŸï¼Œä½¿ç”¨é€—å·ï¼ˆ,ï¼‰åˆ†éš”                          |
> | is_snapshotuser | æ˜¯å¦ä¸ºå¿«ç…§é¡µæ¨¡å¼è™šæ‹Ÿè´¦å·ï¼Œåªæœ‰å½“ç”¨æˆ·æ˜¯å¿«ç…§é¡µæ¨¡å¼è™šæ‹Ÿè´¦å·æ˜¯è¿”å›ï¼Œå€¼ä¸º1 |
>
> é”™è¯¯æ—¶å¾®ä¿¡ä¼šè¿”å› JSON æ•°æ®åŒ…å¦‚ä¸‹ï¼ˆç¤ºä¾‹ä¸º Code æ— æ•ˆé”™è¯¯ï¼‰:
>
> ```json
> {"errcode":40029,"errmsg":"invalid code"}
> ```
>
> [ç¬¬äºŒæ­¥ï¼šé€šè¿‡ code æ¢å–ç½‘é¡µæˆæƒaccess_token - ç½‘é¡µæˆæƒ | å¾®ä¿¡å¼€æ”¾æ–‡æ¡£ (qq.com)](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html#1)

> [!NOTE]
>
> è®¿é—®å¾®ä¿¡æ¥å£éœ€è¦å…ˆåˆ°å¾®ä¿¡å…¬ä¼—å·`åŸºæœ¬é…ç½® - IPç™½åå•`ä¸­æ·»åŠ æœåŠ¡å™¨çš„ ip åœ°å€ã€‚

æ­¤æ—¶å·²ç»å–åˆ°ç”¨æˆ·çš„`openid`äº†ï¼Œå¯ä»¥åšè‡ªèº«ä¸šåŠ¡ç³»ç»Ÿçš„ç™»å½•æˆ–ä¸å¾®ä¿¡ç»‘å®šäº†ã€‚

### è·å–ç”¨æˆ·ä¿¡æ¯

ä¸»è¦ç”¨äºè·å–ç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒ

> å¦‚æœç½‘é¡µæˆæƒä½œç”¨åŸŸä¸ºsnsapi_userinfoï¼Œåˆ™æ­¤æ—¶å¼€å‘è€…å¯ä»¥é€šè¿‡access_tokenå’Œ openid æ‹‰å–ç”¨æˆ·ä¿¡æ¯äº†ã€‚
>
> **è¯·æ±‚æ–¹æ³•**
>
> > httpï¼šGETï¼ˆè¯·ä½¿ç”¨ https åè®®ï¼‰ï¼š
>
> > https://api.weixin.qq.com/sns/userinfo?access_token=ACCESS_TOKEN&openid=OPENID&lang=zh_CN
>
> | å‚æ•°         | æè¿°                                                         |
> | :----------- | :----------------------------------------------------------- |
> | access_token | ç½‘é¡µæˆæƒæ¥å£è°ƒç”¨å‡­è¯,æ³¨æ„ï¼šæ­¤access_tokenä¸åŸºç¡€æ”¯æŒçš„access_tokenä¸åŒ |
> | openid       | ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†                                               |
> | lang         | è¿”å›å›½å®¶åœ°åŒºè¯­è¨€ç‰ˆæœ¬ï¼Œzh_CN ç®€ä½“ï¼Œzh_TW ç¹ä½“ï¼Œen è‹±è¯­        |
>
> **è¿”å›è¯´æ˜**
>
> æ­£ç¡®æ—¶è¿”å›çš„ JSON æ•°æ®åŒ…å¦‚ä¸‹ï¼š
>
> ```json
> {   
>   "openid": "OPENID",
>   "nickname": NICKNAME,
>   "sex": 1,
>   "province":"PROVINCE",
>   "city":"CITY",
>   "country":"COUNTRY",
>   "headimgurl":"https://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/46",
>   "privilege":[ "PRIVILEGE1" "PRIVILEGE2"     ],
>   "unionid": "o6_bmasdasdsad6_2sgVt7hMZOPfL"
> }
> ```
>
> | å‚æ•°       | æè¿°                                                         |
> | :--------- | :----------------------------------------------------------- |
> | openid     | ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†                                               |
> | nickname   | ç”¨æˆ·æ˜µç§°                                                     |
> | sex        | ç”¨æˆ·çš„æ€§åˆ«ï¼Œå€¼ä¸º1æ—¶æ˜¯ç”·æ€§ï¼Œå€¼ä¸º2æ—¶æ˜¯å¥³æ€§ï¼Œå€¼ä¸º0æ—¶æ˜¯æœªçŸ¥      |
> | province   | ç”¨æˆ·ä¸ªäººèµ„æ–™å¡«å†™çš„çœä»½                                       |
> | city       | æ™®é€šç”¨æˆ·ä¸ªäººèµ„æ–™å¡«å†™çš„åŸå¸‚                                   |
> | country    | å›½å®¶ï¼Œå¦‚ä¸­å›½ä¸ºCN                                             |
> | headimgurl | ç”¨æˆ·å¤´åƒï¼Œæœ€åä¸€ä¸ªæ•°å€¼ä»£è¡¨æ­£æ–¹å½¢å¤´åƒå¤§å°ï¼ˆæœ‰0ã€46ã€64ã€96ã€132æ•°å€¼å¯é€‰ï¼Œ0ä»£è¡¨640*640æ­£æ–¹å½¢å¤´åƒï¼‰ï¼Œç”¨æˆ·æ²¡æœ‰å¤´åƒæ—¶è¯¥é¡¹ä¸ºç©ºã€‚è‹¥ç”¨æˆ·æ›´æ¢å¤´åƒï¼ŒåŸæœ‰å¤´åƒ URL å°†å¤±æ•ˆã€‚ |
> | privilege  | ç”¨æˆ·ç‰¹æƒä¿¡æ¯ï¼Œjson æ•°ç»„ï¼Œå¦‚å¾®ä¿¡æ²ƒå¡ç”¨æˆ·ä¸ºï¼ˆchinaunicomï¼‰     |
> | unionid    | åªæœ‰åœ¨ç”¨æˆ·å°†å…¬ä¼—å·ç»‘å®šåˆ°å¾®ä¿¡å¼€æ”¾å¹³å°å¸å·åï¼Œæ‰ä¼šå‡ºç°è¯¥å­—æ®µã€‚ |
>
> é”™è¯¯æ—¶å¾®ä¿¡ä¼šè¿”å› JSON æ•°æ®åŒ…å¦‚ä¸‹ï¼ˆç¤ºä¾‹ä¸º openid æ— æ•ˆï¼‰:
>
> ```json
> {"errcode":40003,"errmsg":" invalid openid "}
> ```
> 
>[ç¬¬å››æ­¥ï¼šæ‹‰å–ç”¨æˆ·ä¿¡æ¯(éœ€ scope ä¸º snsapi_userinfo) - ç½‘é¡µæˆæƒ | å¾®ä¿¡å¼€æ”¾æ–‡æ¡£ (qq.com)](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html#3)

# å¤šä¸ªä¸šåŠ¡ç³»ç»Ÿè·³è½¬çš„é—®é¢˜

ç»æŸ¥è¯¢ï¼Œå¾®ä¿¡å…¬ä¼—å·ä»…å…è®¸è®¾ç½®ä¸€ä¸ªå›è°ƒåŸŸåï¼ˆè¿™â„¢ä¸æ˜¯å‘çˆ¹å—.jpgï¼‰ï¼Œä½†å®ƒä¼¼ä¹ä¸é™åˆ¶å†…éƒ¨çš„é‡å®šå‘ï¼Œæ‰€ä»¥å¯ä»¥åšä¸€ä¸ªé¡µé¢ä¸“é—¨ç”¨äºè·³è½¬ã€‚

nginx å†é€‚åˆä¸è¿‡äº†ğŸ˜Šï¼Œå°†é™æ€ç½‘é¡µæœåŠ¡è®¾ä¸º 80 ç«¯å£

```nginx
server {
    listen       80;
    server_name  localhost;

    #charset koi8-r;

    #access_log  logs/host.access.log  main;

    location / {
        root   html;
        index  index.html index.htm;
    }
}
```

##### åœ¨ html/index.html ä¸­å†™è·³è½¬é€»è¾‘

åœ¨`locations`å˜é‡ä¸­å®šä¹‰å„ä¸ªä¸šåŠ¡ç³»ç»Ÿçš„`syscode`å’Œåœ°å€ï¼Œå¸¦ä¸Š`syscode`å‚æ•°è®¿é—® nginxï¼Œnginx ä¼šé‡å®šå‘åˆ°å¾®ä¿¡ï¼ˆ`redirect_url`ä¸ºè‡ªèº«ï¼‰ï¼Œå–å¾—å¾®ä¿¡`code`åï¼Œå°†æ­¤å‚æ•°æ·»åŠ åˆ°ä¸šåŠ¡ç³»ç»Ÿåœ°å€ä¸­ï¼Œå¹¶é‡å®šå‘ã€‚

```javascript
// è·å–å‚æ•°ä¸ºmap
function getPars(parsStr) {
    var pars = {};
    var arr = parsStr.split(/[?|&]/);
    for (var i = 0; i < arr.length; i++) {
        if (arr[i].indexOf('=') >= 0) {
            var pArr = arr[i].split('=');
            pars[pArr[0]] = decodeURIComponent(pArr[1]);
        }
    }
    return pars;
}

// å°†mapè½¬æ¢ä¸ºé“¾æ¥
function getParsStr(pars) {
    var str = '';
    for (var i in pars) {
        str += '&' + i + '=' + encodeURIComponent(pars[i]);
    }
    return str.replace(/^&/g, '?')
}

var appId = 'xxxxxxxxxx';

var locations = {
    'sjztmobile': 'http://www.example.com/app/index.html#/weChatLogin'
}

var curPars = getPars(location.search)
//alert(JSON.stringify(curPars))

function open() {
    if (!curPars['syscode']) {
        console.error('requires syscode parameter');
        return;
    }

    if (!curPars['code']) {
        location = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + appId + '&redirect_uri=' + encodeURIComponent(location.href) + '&response_type=code&scope=snsapi_userinfo&state=STATE&connect_redirect=1#wechat_redirect'
        return;
    }

    var url = new URL(locations[curPars['syscode']])
    var pars = getPars(url.search);
    pars.code = curPars['code'];
    pars.state = curPars['state'];
    url.search = getParsStr(pars);
    location = url.href;
}
open();
```

å¯å°†å„ä¸ªä¸šåŠ¡ç³»ç»Ÿçš„é“¾æ¥é…ç½®åˆ°`locations`å˜é‡ä¸­ï¼Œå¯åœ¨å¾®ä¿¡ä¸­è®¿é—®ï¼š

```
http://www.nginxurl.com/?syscode=sjztmobile
// æˆ–è€…
// å®é™…ä¸Šè¿™ä¸ªå°±æ˜¯nginxé‡å®šå‘çš„å¾®ä¿¡åœ°å€
https://open.weixin.qq.com/connect/oauth2/authorize?appid=xxxxxxxxxx&redirect_uri=http%3A%2F%2Fwww.nginxurl.com%2F%3Fsyscode%3Dsjztmobile&response_type=code&scope=snsapi_userinfo&state=STATE&connect_redirect=1#wechat_redirect
```

å–å¾— code åï¼Œå¾®ä¿¡ä¼šé‡å®šå‘åˆ°ï¼š

```
http://www.nginxurl.com/?syscode=sjztmobile&code=xxxxxxxxxxxx&state=STATE
```

nginx é‡å®šå‘åˆ°ä¸šåŠ¡ç³»ç»Ÿ`sjztmobile`ï¼š

```
http://www.example.com/app/index.html?code=xxxxxxxxxxxx&state=STATE#/weChatLogin
```

> [!TIP]
>
> è·å¾— code åå³è·Ÿå›è°ƒåŸŸåå®Œå…¨æ²¡æœ‰å…³ç³»äº†ï¼Œè·å– access_token/openid åªä¼šæ ¡éªŒ ip ç™½åå•ï¼Œåœ¨å¾®ä¿¡å…¬ä¼—å·`åŸºæœ¬é…ç½® - IPç™½åå•`ä¸­æ·»åŠ æœåŠ¡å™¨çš„ ip åœ°å€å³å¯ã€‚

### node.js æœåŠ¡å™¨ç‰ˆæœ¬

ä¾èµ–ç»„ä»¶ï¼š`express`

redirect-config.js

```javascript
const appId = 'xxxxxxxxxxx'

const locations = {
    'sjztmobile': 'http://www.example.com/app/index.html#/weChatLogin'
}

module.exports = {
    appId,
    locations
}
```

utils.js

```javascript
function getPars(parsStr) {
    var pars = {};
    var arr = parsStr.split(/[?|&]/);
    for (var i = 0; i < arr.length; i++) {
        if (arr[i].indexOf('=') >= 0) {
            var pArr = arr[i].split('=');
            pars[pArr[0]] = decodeURIComponent(pArr[1]);
        }
    }
    return pars;
}

function getParsStr(pars) {
    var str = '';
    for (var i in pars) {
        str += '&' + i + '=' + encodeURIComponent(pars[i]);
    }
    return str.replace(/^&/g, '?')
}

module.exports = {
    getPars,
    getParsStr
}
```

å…¥å£æ–‡ä»¶ index.js

```javascript
const express = require('express')
const app = express()
const port = 3000

const rdConfig = require('./redirect-config.js')
const utils = require('./utils.js')

app.get('/redirect/:syscode', (req, res) => {
    let url = rdConfig.locations[req.params.syscode]
    if(!url) {
        console.error('requires syscode parameter');
        res.send('redirect url config not found!')
        return
    }

    if(!req.query.code){
        res.redirect('https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + appId + '&redirect_uri=' + encodeURIComponent(location.href) + '&response_type=code&scope=snsapi_userinfo&state=STATE&connect_redirect=1#wechat_redirect')
        return
    }

    let urlO = new URL(url)
    let pars = utils.getPars(urlO.search);
    pars.code = curPars['code'];
    pars.state = curPars['state'];
    urlO.search = utils.getParsStr(pars);
    res.redirect(urlO.href)
})

app.listen(port, () => {
  console.log(`Server listening on port ${port}`)
  console.log(`WeChat AppId: ${rdConfig.appId}`)
  console.log(`Redirect urls config: `)
  console.log(JSON.stringify(rdConfig.locations))
})
```

