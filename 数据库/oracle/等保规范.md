# 等保规范



# 密码强度要求

### utlpwdmg.sql

PASSWORD_VERIFY_FUNCTION 8，密码复杂度8个字符

> 修改密码复杂度（如长度）须通过修改 utlpwdmg.sql 方式

PASSWORD_LIFE_TIME 90，口令有效期90天

PASSWORD_REUSE_MAX ５，禁止使用最近5次使用的口令

PASSWORD_GRACE_TIME 5，密码失效后锁定5分钟

FAILED_LOGIN_ATTEMPTS 5，连续输错密码5次，第6次锁定用户

```bash
[oracle@localhost response]$ cd /usr/local/oracle/product/11.2.0/db_1/rdbms/admin/
# 备份utlpwdmg.sql
[oracle@localhost admin]$ cp utlpwdmg.sql utlpwdmg.sql.bak
[oracle@localhost admin]$ vi utlpwdmg.sql
```

修改`PASSWORD_LIFE_TIME`/`PASSWORD_REUSE_MAX`/`PASSWORD_GRACE_TIME`/`FAILED_LOGIN_ATTEMPTS`参数

```sql
ALTER PROFILE DEFAULT LIMIT
PASSWORD_LIFE_TIME 90
PASSWORD_GRACE_TIME 5
PASSWORD_REUSE_TIME UNLIMITED
PASSWORD_REUSE_MAX 5
FAILED_LOGIN_ATTEMPTS 5
PASSWORD_LOCK_TIME 1
PASSWORD_VERIFY_FUNCTION verify_function_11G;
```

修改密码长度

```sql
   -- Check for the minimum length of the password
   IF length(password) < 8 THEN
      raise_application_error(-20001, 'Password length less than 8');
   END IF;
```

执行 utlpwdmg.sql

```sql
[oracle@localhost admin]$ sqlplus SYS/123456 as sysdba

SQL*Plus: Release 11.2.0.1.0 Production on Fri Jul 30 11:42:55 2021

Copyright (c) 1982, 2009, Oracle.  All rights reserved.


Connected to:
Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options

SQL> @utlpwdmg.sql

Function created.


Profile altered.


Function created.
```



##### Alter 修改参数

`PASSWORD_LIFE_TIME`/`PASSWORD_REUSE_MAX`/`PASSWORD_GRACE_TIME`/`FAILED_LOGIN_ATTEMPTS`等参数可以使用 alter 修改

```sql
-- 修改错误尝试次数
alter profile default limit FAILED_LOGIN_ATTEMPTS 5;
```

##### 查询参数

```sql
-- 查询密码有效期（天）
select * FROM dba_profiles s Where s.profile='DEFAULT' AND resource_name='PASSWORD_LIFE_TIME';
```

# 使用自建角色管理数据库

不使用系统角色 DBA（CONNECT、RESOURCE），使用自建的角色对用户进行粒度更细的权限管理

> 参看 [自建角色授权](/数据库/oracle/sqlplus?id=自建角色授权)

# 在sqlnet.ora中设置SQLNET.AUTHENTICATION_SERVICES=NONE来禁用 SYSDBA 角色的自动登录

导致本地以 sysdba 身份登录时报 `ORA-01031: 权限不足`，同时无法停止/启动实例，:dog::dog:

> **1 、在windows 下，SQLNET.AUTHENTICATION_SERVICES 必须设置为NTS 或者ALL 才能使用OS 认证；不设置或者设置为其他任何值都不能使用OS 认证。**
> 
> **sqlnet.ora\**在\**WINDOWS下位于%ORACLE_HOME%NETWORKADMIN目录\**。\**
> **
> 
> **2 、在linux 下，在SQLNET.AUTHENTICATION_SERVICES 的值设置为ALL ，或者不设置的情况下，OS 验证才能成功；设置为其他任何值都不能使用OS 认证。**
> 
> [以sysdba身份登录oracle报ORA-1031权限不足错误之完美分析_艺俊的博客-CSDN博客_sysdba登录ora01031权限不足](https://blog.csdn.net/qq_23412263/article/details/52234095)

如果非要设置`SQLNET.AUTHENTICATION_SERVICES=NONE`，当需要停止/启动实例，或者需要使用 sysdba 身份的时候，先删除该配置或改为`ALL`，操作完成后再设为`NONE`

```bash
[root@localhost ~]# su -l oracle
[oracle@localhost db_1]$ cd $ORACLE_HOME/network/admin
[oracle@localhost admin]$ vi sqlnet.ora
```

修改是立即生效的，修改后直接登入

```bash
sqlplus YNCNT/password as sysdba
```

例如修改秘密：

```sql
alter user YNCNT identified by password1 account unlock;
```

# 开启监听器日志功能是为了捕获监听器命令和防止密码被暴力破解

切换到oracle的管理员，执行下列命令

$ORACLE_HOME/bin/lsnrctl

LSNRCTL> set log_directory <oracle_home路径>/network/admin

LSNRCTL> set log_file <sid名称>.log

LSNRCTL> set log_status on

LSNRCTL> save_config

在 oracle 11g 报错，`TNS-01251: Cannot set trace/log directory under ADR`

> Oracle 11g中引入了ADR特性。
> 
> 如果listener.ora文件中参数DIAG_ADR_ENABLED_listenername设置为on，则会忽略参数log_directory的设置。 trace文件和log文件被创建在ADR_BASE_listener_name指定的路径下。可以通过参数ADR_BASE_listener_name参数指定的位置作为trace和log文件的存放的base目录。
> 
> 也可以通过在listener.ora中设置，取消ADR特性：
> 
> ```properties
> DIAG_ADR_ENABLED_listener_name=OFF 
> 
> LOG_DIRECTORY_listener_name = </path/.../>
> ```
> 
> [TNS-01251: Cannot set trace/log directory under ADR - abce - 博客园 (cnblogs.com)](https://www.cnblogs.com/abclife/p/4611586.html)



### 确定监听器名称

```bash
cd $ORACLE_HOME/network/admin
vi listener.ora
# listener.ora Network Configuration File: /usr/local/oracle/product/11.2.0/db_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))
      (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
    )
  )
```

或者

```bash
[oracle@localhost admin]$ ps -ef|grep lsn
oracle    69159      1  0 16:56 ?        00:00:00 /usr/local/oracle/product/11.2.0/db_1/bin/tnslsnr LISTENER -inherit
oracle    70516  68762  0 17:22 pts/0    00:00:00 grep --color=auto lsn
```

确定监听器名称为 `LISTENER`

关闭 ADR 特性，配置日志参数

```bash
DIAG_ADR_ENABLED_LISTENER=OFF

# 这里可以在关闭ADR、重启lsnrctl之后，通过上述的LSNRCTL命令行配置
#----ADDED BY TNSLSNR 31-JUL-2021 17:01:42---
LOGGING_LISTENER = ON
LOG_FILE_LISTENER = orcl.log
LOG_DIRECTORY_LISTENER = /usr/local/oracle/product/11.2.0/db_1/network/admin
#--------------------------------------------
```

重启监听

```bash
lsnrctl reload
```

